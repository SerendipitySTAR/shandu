# 搜索引擎429错误解决方案

## 问题描述
在生成报告过程中遇到Google搜索的429错误（Too Many Requests），这是由于短时间内发送过多搜索请求触发了Google的速率限制。

## 已实施的解决方案

### 1. 改进的搜索引擎优先级
- **默认引擎顺序**：DuckDuckGo → Wikipedia → Bing → Google
- **Google作为最后选择**：只在其他引擎失败时使用
- **智能跳过**：自动跳过已失败的搜索引擎

### 2. 增强的速率限制机制
- **指数退避策略**：重试间隔为2、4、8秒，带随机抖动
- **Google特殊处理**：Google搜索间隔加倍，最小3秒间隔
- **429错误专门处理**：检测到429错误时使用更长的退避时间（6-20秒）

### 3. 智能错误恢复
- **引擎失败标记**：标记失败的引擎，避免重复使用
- **自动降级**：Google失败时自动切换到其他引擎
- **缓存优先**：优先使用缓存结果，减少API调用

### 4. 配置优化
- **并发限制**：从5个并发请求降低到2个
- **结果数量**：从10个减少到8个，Google限制为5个
- **超时设置**：15秒超时，避免长时间等待

## 使用建议

### 立即解决方案
1. **重新运行生成**：系统现在会自动避免Google搜索
2. **等待一段时间**：如果需要使用Google，等待1-2小时后再试
3. **使用其他引擎**：DuckDuckGo和Wikipedia通常更稳定

### 长期配置
```python
# 在配置中禁用Google搜索
searcher = UnifiedSearcher(max_results=5)
results = await searcher.search(query, engines=["duckduckgo", "wikipedia"])
```

### 环境变量设置
```bash
# 设置用户代理避免被识别为爬虫
export USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

## 代码改进详情

### 新增功能
1. `_should_skip_google()` - 检查是否应跳过Google搜索
2. `_mark_engine_failed()` - 标记失败的搜索引擎
3. `_mark_google_search()` - 记录Google搜索时间用于速率限制

### 改进的重试逻辑
- 429错误特殊处理
- 引擎失败自动标记
- 更智能的退避策略

### 搜索引擎优先级
1. **DuckDuckGo** - 最稳定，无严格速率限制
2. **Wikipedia** - 可靠的学术资源
3. **Bing** - 备用选择
4. **Google** - 仅在必要时使用

## 测试验证

运行测试脚本验证改进：
```bash
python test_search_fix.py
```

## 监控和日志

系统现在会记录：
- 搜索引擎选择决策
- 速率限制检测
- 引擎失败标记
- 缓存使用情况

查看日志：
```bash
tail -f ~/.shandu/logs/shandu_$(date +%Y-%m-%d).log
```

## 故障排除

### 如果所有搜索引擎都失败
1. 检查网络连接
2. 检查防火墙设置
3. 尝试使用代理
4. 等待一段时间后重试

### 如果仍然遇到429错误
1. 增加搜索间隔时间
2. 减少并发搜索数量
3. 使用不同的用户代理
4. 考虑使用API密钥（如果可用）

这些改进应该能够有效解决429错误问题，并提供更稳定的搜索体验。
