# å­—æ•°æ§åˆ¶ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·åæ˜ ç”Ÿæˆçš„æŠ¥å‘Šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **å­—æ•°è™šå‡** - æŠ¥å‘Šå®é™…å­—æ•°è¿œå°‘äºæ ‡æ³¨çš„å­—æ•°è¦æ±‚
2. **å†…å®¹è¿‡äºç®€ç•¥** - ç« èŠ‚å†…å®¹ç¼ºä¹æ·±åº¦ï¼Œåƒæ˜¯è¦ç‚¹ç½—åˆ—è€Œéæ·±åº¦åˆ†æ
3. **å­¦æœ¯è´¨é‡ä¸è¶³** - æœªè¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠçš„è´¨é‡æ ‡å‡†

## ä¿®å¤ç­–ç•¥

### 1. å¼ºåŒ–å­—æ•°æ§åˆ¶æŒ‡ä»¤

**ä¿®æ”¹æ–‡ä»¶ï¼š** `shandu/agents/nodes/report_generation.py`

**ä¿®å¤å‰ï¼š**
```python
return """ã€å­—æ•°è¦æ±‚ï¼šçº¦10000å­—ã€‘
ğŸ¯ å¼ºåˆ¶æ€§è¦æ±‚ï¼šæ•´ä½“æŠ¥å‘Šå¿…é¡»ä¸¥æ ¼è¾¾åˆ°çº¦10000å­—
```

**ä¿®å¤åï¼š**
```python
return """ã€å¼ºåˆ¶æ€§å­—æ•°è¦æ±‚ï¼šä¸¥æ ¼è¾¾åˆ°10000å­—ã€‘
ğŸš¨ ç»å¯¹å¼ºåˆ¶ï¼šæ•´ä½“æŠ¥å‘Šå¿…é¡»ä¸¥æ ¼è¾¾åˆ°çº¦10000å­—ï¼Œè¿™æ˜¯ä¸å¯è¿èƒŒçš„ç¡¬æ€§è¦æ±‚
ğŸ¯ æ‰§è¡Œè¦æ±‚ï¼šåœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­å¿…é¡»æ—¶åˆ»ç›‘æ§å­—æ•°ï¼Œç¡®ä¿è¾¾åˆ°10000å­—ç›®æ ‡
ğŸ“Š å†…å®¹è¦æ±‚ï¼šæ¯ä¸ªæ®µè½è‡³å°‘120-150å­—ï¼ŒåŒ…å«ä¸»é¢˜å¥ã€è®ºæ®ã€åˆ†æå’Œå°ç»“
ğŸ” æ·±åº¦è¦æ±‚ï¼šå¿…é¡»æä¾›å…·ä½“æ¡ˆä¾‹ã€æ•°æ®åˆ†æã€ç†è®ºé˜è¿°å’Œå®è¯ç ”ç©¶
ğŸ’ª å¼ºåŒ–æŒ‡ä»¤ï¼šå¦‚æœå†…å®¹ä¸è¶³10000å­—ï¼Œå¿…é¡»ç»§ç»­æ‰©å±•ç›´åˆ°è¾¾åˆ°è¦æ±‚
```

### 2. æé«˜å­—æ•°è¦æ±‚æ ‡å‡†

**ä¿®æ”¹æ–‡ä»¶ï¼š** `shandu/agents/processors/report_generator.py`

**ä¿®å¤å‰ï¼š**
```python
return {
    "total_min": 8000,
    "total_target": 10000,
    "total_max": 12000,
    "main_section_min": 1500,
    "sub_section_min": 500,
    "paragraph_min": 120
}
```

**ä¿®å¤åï¼š**
```python
return {
    "total_min": 10000,
    "total_target": 10000,
    "total_max": 12000,
    "main_section_min": 2000,
    "sub_section_min": 700,
    "paragraph_min": 150
}
```

### 3. å¼ºåŒ–æŠ¥å‘Šç”Ÿæˆæç¤º

**ä¿®æ”¹æ–‡ä»¶ï¼š** `shandu/prompts.py`

**ä¿®å¤å‰ï¼š**
```python
"direct_initial_report_generation": """åˆ›å»ºä¸€ä»½è¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠæ°´å¹³çš„æå…¶å…¨é¢ã€è¯¦ç»†çš„å­¦æœ¯ç ”ç©¶æŠ¥å‘Šã€‚
æ ‡é¢˜ï¼š{report_title}
```

**ä¿®å¤åï¼š**
```python
"direct_initial_report_generation": """åˆ›å»ºä¸€ä»½è¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠæ°´å¹³çš„æå…¶å…¨é¢ã€è¯¦ç»†çš„å­¦æœ¯ç ”ç©¶æŠ¥å‘Šã€‚

{length_instruction}

æ ‡é¢˜ï¼š{report_title}
### å¼ºåˆ¶æ€§å­¦æœ¯ç»“æ„è¦æ±‚ï¼š
5. ğŸš¨ ç»å¯¹å¼ºåˆ¶ï¼šå¿…é¡»ä¸¥æ ¼éµå¾ªä¸Šè¿°å­—æ•°æ§åˆ¶æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸å¯è¿èƒŒçš„ç¡¬æ€§è¦æ±‚
```

### 4. æ–°å¢å¼ºåˆ¶å­—æ•°éªŒè¯åŠŸèƒ½

**æ–°å¢å‡½æ•°ï¼š** `force_word_count_compliance`

```python
async def force_word_count_compliance(
    llm: ChatOpenAI,
    report_content: str,
    detail_level: str,
    language: str = "zh"
) -> str:
    """å¼ºåˆ¶ç¡®ä¿æŠ¥å‘Šè¾¾åˆ°å­—æ•°è¦æ±‚"""
    requirements = get_word_count_requirements(detail_level)
    current_word_count = len(report_content)
    
    if current_word_count >= requirements['total_min']:
        return report_content
    
    # å¼ºåˆ¶æ€§å…¨æ–‡æ‰©å±•
    needed_words = requirements['total_target'] - current_word_count
    force_expansion_prompt = f"""ğŸš¨ğŸš¨ ç´§æ€¥å¼ºåˆ¶æ€§è¦æ±‚ï¼šä»¥ä¸‹æŠ¥å‘Šå­—æ•°ä¸¥é‡ä¸è¶³ï¼Œå¿…é¡»ç«‹å³æ‰©å±•è‡³{requirements['total_target']}å­—ï¼š
    
    å½“å‰å­—æ•°ï¼š{current_word_count}å­—
    ç›®æ ‡å­—æ•°ï¼š{requirements['total_target']}å­—
    éœ€è¦å¢åŠ ï¼š{needed_words}å­—
    
    ### å¼ºåˆ¶æ€§å…¨æ–‡æ‰©å±•è¦æ±‚ï¼š
    ğŸ”¥ ç»å¯¹å¿…é¡»è¾¾åˆ°{requirements['total_target']}å­—ï¼Œè¿™æ˜¯ä¸å¯è¿èƒŒçš„ç¡¬æ€§è¦æ±‚
    ğŸ“ å¿…é¡»å¤§å¹…æ‰©å±•æ¯ä¸ªç« èŠ‚çš„å†…å®¹æ·±åº¦å’Œå¹¿åº¦
    ğŸ’¡ å¿…é¡»ä¸ºæ¯ä¸ªä¸»è¦ç« èŠ‚æ·»åŠ æ›´å¤šå­ç« èŠ‚å’Œæ®µè½
    ğŸ“ å¿…é¡»ç¡®ä¿å­¦æœ¯æ·±åº¦ï¼Œè¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠæ°´å¹³
    """
```

### 5. å¼ºåŒ–ç« èŠ‚æ‰©å±•æœºåˆ¶

**ä¿®æ”¹æ–‡ä»¶ï¼š** `shandu/agents/processors/report_generator.py`

**æ–°å¢ä¸‰æ¬¡æ‰©å±•éªŒè¯ï¼š**
```python
# éªŒè¯æ‰©å±•åçš„å†…å®¹æ˜¯å¦è¾¾åˆ°è¦æ±‚
expanded_word_count = len(expanded_section)
if expanded_word_count < requirements['main_section_min']:
    # äºŒæ¬¡æ‰©å±•
    if final_word_count < requirements['main_section_min']:
        # ä¸‰æ¬¡æ‰©å±•
```

### 6. é›†æˆå¼ºåˆ¶éªŒè¯åˆ°æŠ¥å‘Šç”Ÿæˆæµç¨‹

**ä¿®æ”¹æ–‡ä»¶ï¼š** `shandu/agents/nodes/report_generation.py`

**åœ¨æŠ¥å‘Šå¢å¼ºåæ·»åŠ ï¼š**
```python
# ğŸš¨ æ–°å¢ï¼šå¼ºåˆ¶å­—æ•°éªŒè¯å’Œæ‰©å±•
console.print("[bold blue]è¿›è¡Œæœ€ç»ˆå­—æ•°éªŒè¯å’Œå¼ºåˆ¶æ‰©å±•...[/]")
enhanced_report_str = await force_word_count_compliance(llm, enhanced_report_str, current_detail_level, language)
```

**åœ¨ç« èŠ‚æ‰©å±•åæ·»åŠ ï¼š**
```python
# ğŸš¨ æ–°å¢ï¼šæœ€ç»ˆå¼ºåˆ¶å­—æ•°éªŒè¯å’Œæ‰©å±•
console.print("[bold blue]è¿›è¡Œæœ€ç»ˆå¼ºåˆ¶å­—æ•°éªŒè¯...[/]")
final_expanded_report = await force_word_count_compliance(llm, final_expanded_report, current_detail_level, language)
```

## ä¿®å¤æ•ˆæœ

### æ–°çš„å­—æ•°æ ‡å‡†

| è¯¦ç»†ç¨‹åº¦ | ç›®æ ‡å­—æ•° | æœ€å°å­—æ•° | ä¸»ç« èŠ‚æœ€å° | å­ç« èŠ‚æœ€å° |
|---------|---------|---------|-----------|-----------|
| brief | 4000å­— | 4000å­— | 800å­— | 300å­— |
| standard | 10000å­— | 10000å­— | 2000å­— | 700å­— |
| detailed | 15000å­— | 15000å­— | 2500å­— | 1000å­— |
| custom_X | Xå­— | Xå­— | X/5å­— | X/12å­— |

### å¼ºåŒ–çš„å­—æ•°æ§åˆ¶æµç¨‹

```
1. CLIå‚æ•° --report-detail â†’ state['detail_level']
2. _get_length_instruction(detail_level) â†’ å¼ºåˆ¶æ€§å­—æ•°æ§åˆ¶æŒ‡ä»¤
3. generate_initial_report(..., length_instruction) â†’ åˆå§‹æŠ¥å‘Šï¼ˆéµå¾ªå­—æ•°è¦æ±‚ï¼‰
4. enhance_report(..., length_instruction) â†’ å¢å¼ºæŠ¥å‘Šï¼ˆä¿æŒå­—æ•°è¦æ±‚ï¼‰
5. force_word_count_compliance() â†’ å¼ºåˆ¶å­—æ•°éªŒè¯å’Œæ‰©å±•
6. expand_key_sections(..., length_instruction) â†’ ç« èŠ‚æ‰©å±•ï¼ˆè¾¾åˆ°ç›®æ ‡å­—æ•°ï¼‰
7. force_word_count_compliance() â†’ æœ€ç»ˆå­—æ•°éªŒè¯
```

### æµ‹è¯•éªŒè¯ç»“æœ

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š
- å­—æ•°æ§åˆ¶å‡½æ•°æ­£ç¡®å·¥ä½œ
- å¼ºåˆ¶æ€§æŒ‡ä»¤åŒ…å«æ­£ç¡®çš„å­—æ•°è¦æ±‚
- æŠ¥å‘Šç”ŸæˆèŠ‚ç‚¹æ­£ç¡®é›†æˆå­—æ•°æ§åˆ¶
- å¤„ç†å™¨æ­£ç¡®ä¼ é€’å­—æ•°æ§åˆ¶æŒ‡ä»¤

## ä½¿ç”¨å»ºè®®

### æµ‹è¯•ä¸åŒè¯¦ç»†ç¨‹åº¦

```bash
# ç®€è¦æŠ¥å‘Šï¼ˆ4000å­—ï¼‰
python -m shandu research "è¥¿æ¸¸è®°ä¸»é¢˜åˆ†æ" --language zh --report-detail brief

# æ ‡å‡†æŠ¥å‘Šï¼ˆ10000å­—ï¼‰
python -m shandu research "è¥¿æ¸¸è®°ä¸»é¢˜åˆ†æ" --language zh --report-detail standard

# è¯¦ç»†æŠ¥å‘Šï¼ˆ15000å­—ï¼‰
python -m shandu research "è¥¿æ¸¸è®°ä¸»é¢˜åˆ†æ" --language zh --report-detail detailed

# è‡ªå®šä¹‰å­—æ•°æŠ¥å‘Šï¼ˆ15000å­—ï¼‰
python -m shandu research "è¥¿æ¸¸è®°ä¸»é¢˜åˆ†æ" --language zh --report-detail custom_15000
```

### è§‚å¯Ÿè¦ç‚¹

1. **åˆå§‹æŠ¥å‘Šå­—æ•°** - æ£€æŸ¥åˆå§‹æŠ¥å‘Šæ˜¯å¦å°±è¾¾åˆ°äº†é¢„æœŸå­—æ•°èŒƒå›´
2. **å†…å®¹æ·±åº¦** - éªŒè¯æŠ¥å‘Šå†…å®¹æ˜¯å¦è¾¾åˆ°å­¦æœ¯æ·±åº¦è¦æ±‚
3. **å­—æ•°æ§åˆ¶æŒ‡ä»¤** - ç¡®è®¤å­—æ•°æ§åˆ¶æŒ‡ä»¤åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ­£ç¡®æ˜¾ç¤º
4. **æœ€ç»ˆå­—æ•°** - éªŒè¯æœ€ç»ˆæŠ¥å‘Šæ˜¯å¦è¾¾åˆ°ç›®æ ‡å­—æ•°

## æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **shandu/agents/processors/report_generator.py**
   - æé«˜å­—æ•°è¦æ±‚æ ‡å‡†
   - æ–°å¢ `force_word_count_compliance` å‡½æ•°
   - å¼ºåŒ–ç« èŠ‚æ‰©å±•æœºåˆ¶

2. **shandu/agents/nodes/report_generation.py**
   - å¼ºåŒ–å­—æ•°æ§åˆ¶æŒ‡ä»¤
   - é›†æˆå¼ºåˆ¶å­—æ•°éªŒè¯åˆ°æŠ¥å‘Šç”Ÿæˆæµç¨‹
   - å¯¼å…¥æ–°çš„å¼ºåˆ¶éªŒè¯å‡½æ•°

3. **shandu/prompts.py**
   - åœ¨æ‰€æœ‰æŠ¥å‘Šç”Ÿæˆæç¤ºä¸­æ·»åŠ å­—æ•°æ§åˆ¶æŒ‡ä»¤
   - å¼ºåŒ–å­¦æœ¯è´¨é‡è¦æ±‚

### æ ¸å¿ƒæ”¹è¿›

1. **å¼ºåˆ¶æ€§è¯­è¨€** - ä½¿ç”¨"ğŸš¨ ç»å¯¹å¼ºåˆ¶"ã€"ç¡¬æ€§è¦æ±‚"ç­‰å¼ºåˆ¶æ€§è¯­è¨€
2. **å¤šæ¬¡éªŒè¯** - åœ¨æŠ¥å‘Šç”Ÿæˆçš„å¤šä¸ªé˜¶æ®µè¿›è¡Œå­—æ•°éªŒè¯
3. **è‡ªåŠ¨æ‰©å±•** - å½“å­—æ•°ä¸è¶³æ—¶è‡ªåŠ¨è¿›è¡Œå¼ºåˆ¶æ‰©å±•
4. **å­¦æœ¯æ ‡å‡†** - æ˜ç¡®è¦æ±‚è¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠè´¨é‡æ ‡å‡†

## é¢„æœŸæ•ˆæœ

ä¿®å¤åçš„ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿï¼š

1. **ä¸¥æ ¼æ§åˆ¶å­—æ•°** - ç”Ÿæˆçš„æŠ¥å‘Šå­—æ•°ä¸æ ‡æ³¨å­—æ•°ä¸€è‡´
2. **æé«˜å†…å®¹æ·±åº¦** - æ¯ä¸ªç« èŠ‚åŒ…å«å……åˆ†çš„åˆ†æå’Œè®ºè¿°
3. **è¾¾åˆ°å­¦æœ¯æ ‡å‡†** - æŠ¥å‘Šè´¨é‡è¾¾åˆ°ç¡•å£«è®ºæ–‡æˆ–å­¦æœ¯æœŸåˆŠæ°´å¹³
4. **è‡ªåŠ¨è´¨é‡ä¿è¯** - ç³»ç»Ÿè‡ªåŠ¨ç¡®ä¿æŠ¥å‘Šè¾¾åˆ°å­—æ•°å’Œè´¨é‡è¦æ±‚

é€šè¿‡è¿™äº›ä¿®å¤ï¼Œç”¨æˆ·åæ˜ çš„"å­—æ•°è™šå‡"é—®é¢˜åº”è¯¥å¾—åˆ°æ ¹æœ¬æ€§è§£å†³ã€‚
