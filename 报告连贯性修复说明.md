# 报告连贯性修复说明

## 问题诊断

通过深入分析代码，发现当前报告生成流程存在以下核心问题导致"拼凑式"报告：

### 1. 分段处理导致连贯性丢失
- 报告生成分为三个独立阶段：`generate_initial_report` → `enhance_report` → `expand_key_sections`
- 每个阶段都是独立处理，缺乏整体连贯性控制
- 特别是 `expand_key_sections` 只处理前3个重要章节，导致报告结构不完整

### 2. 提示词设计问题
- 当前提示词更注重单个章节的扩展，而非整体报告的连贯性
- 缺乏明确的"深度报告"vs"文章拼凑"的区分指导
- 没有强调章节间的逻辑联系和过渡

### 3. 结构化输出被忽略
- 代码中定义了 `InitialReport` 结构化模型，但在实际生成中经常回退到简单的字符串处理
- 缺乏整体一致性检查机制

## 修复方案

### 1. 强化提示词连贯性要求

#### 修改中文报告生成提示词 (`shandu/prompts.py`)

**原有问题：**
- 提示词缺乏明确的连贯性要求
- 没有强调避免"拼凑式"结构

**修复内容：**
```python
## 核心任务：创建连贯的深度学术报告

您的任务是创建一份深入、全面、连贯的学术研究报告，而不是简单地拼凑多篇文章。

### 连贯性要求（最重要）：
1. 【整体统一性】报告必须作为一个统一的整体，各部分之间有清晰的逻辑联系和自然过渡
2. 【深度分析】不仅仅是信息的罗列，而是要提供深入的分析、独到的见解和综合性判断
3. 【有机结构】章节安排应自然流畅，避免生硬的主题分割，确保内容的有机融合
4. 【一致视角】整篇报告应保持一致的分析视角、论述风格和学术水准

## 关键强调
**这必须是一份连贯的深度学术研究报告，而不是多篇独立文章的简单组合或拼凑。**
- 避免"主题A + 主题B + 主题C"的简单并列结构
- 追求"深度挖掘 + 综合分析 + 系统论述"的学术品质
```

#### 修改报告增强提示词

**修复内容：**
```python
## 核心任务：增强报告连贯性和深度

您的任务是将现有报告转化为一份连贯的深度学术研究报告，而不是简单的内容扩展。

### 连贯性增强要求（最重要）：
1. 【整体统一性】确保所有章节形成有机整体，各部分之间有清晰的逻辑联系和自然过渡
2. 【深度分析】将信息罗列转化为深入分析，提供独到见解和综合性判断
3. 【逻辑脉络】建立从引言到结论的清晰逻辑脉络，避免章节间的突兀跳跃
4. 【论述连贯】确保每个章节都为整体论述服务，避免独立成篇的感觉
```

### 2. 移除章节处理限制

#### 问题定位
在 `shandu/agents/nodes/report_generation.py` 和 `shandu/agents/processors/report_generator.py` 中发现：

```python
# 原有问题代码
important_sections = important_sections[:3]  # 只处理前3个章节
```

#### 修复方案
```python
# 【修复】移除3个章节的限制，处理所有重要章节以确保报告完整性
# 注释：原来只处理前3个章节导致报告不完整，现在处理所有重要章节
```

**影响：**
- 确保所有重要章节都得到处理和扩展
- 避免因章节不完整导致的拼凑感
- 提高报告的整体性和完整性

### 3. 新增整体连贯性检查

#### 新增连贯性检查函数

在 `shandu/agents/nodes/report_generation.py` 中新增：

```python
async def _ensure_report_coherence(
    llm,
    report: str,
    original_query: str,
    language: str = "zh",
    current_date: str = ""
) -> str:
    """
    确保报告的整体连贯性，将拼凑式的内容转化为连贯的深度报告。
    """
    # 使用连贯性检查提示词进行分析
    # 如果发现连贯性问题，自动进行修复
    # 返回优化后的连贯报告
```

#### 集成到报告生成流程

```python
# 【新增】整体连贯性检查和优化
console.print("[bold blue]Performing final coherence check...[/]")
final_expanded_report = await _ensure_report_coherence(
    llm=llm,
    report=final_expanded_report,
    original_query=state.get('query', ''),
    language=language,
    current_date=current_date
)
```

## 修复效果

### 预期改进

1. **整体连贯性**
   - 报告各章节之间有清晰的逻辑联系和自然过渡
   - 避免简单的主题并列结构
   - 形成有机的整体论述

2. **深度分析**
   - 从信息罗列转向深入分析
   - 提供独到见解和综合性判断
   - 挖掘现象背后的深层原因

3. **完整性**
   - 处理所有重要章节，不再限制为3个
   - 确保报告结构完整
   - 避免因章节缺失导致的不完整感

4. **质量保证**
   - 最终连贯性检查确保报告质量
   - 自动识别和修复连贯性问题
   - 保持一致的学术水准

### 使用建议

1. **测试参数**
   ```bash
   # 使用中文语言参数
   --language zh
   
   # 测试不同详细程度
   --report-detail detailed
   --report-detail custom_15000
   ```

2. **观察要点**
   - 检查章节间的逻辑过渡
   - 验证是否避免了简单拼凑
   - 确认所有重要章节都得到处理
   - 观察整体论述的连贯性

3. **质量评估**
   - 报告是否读起来像一篇完整的学术论文
   - 各章节是否为整体论述服务
   - 是否具有深度分析而非信息堆砌
   - 语言表达是否连贯流畅

## 技术细节

### 修改文件清单

1. `shandu/prompts.py`
   - 修改 `SYSTEM_PROMPTS_ZH["report_generation"]`
   - 修改 `SYSTEM_PROMPTS_ZH["report_enhancement"]`

2. `shandu/agents/nodes/report_generation.py`
   - 新增 `_ensure_report_coherence` 函数
   - 修改 `expand_key_sections_node` 流程
   - 移除3个章节的限制

3. `shandu/agents/processors/report_generator.py`
   - 移除 `expand_key_sections` 中的章节限制

### 向后兼容性

- 所有修改都保持向后兼容
- 不影响现有的英文报告生成
- 保留原有的错误处理机制
- 新增功能在出错时会优雅降级

## 总结

通过这次全面的修复，我们从根本上解决了报告生成的"拼凑式"问题：

1. **从源头解决**：修改提示词，明确要求生成连贯的深度报告
2. **流程优化**：移除章节限制，确保完整性
3. **质量保证**：新增连贯性检查，确保最终质量

这些修改将显著提升报告的学术质量和阅读体验，使其真正成为连贯的深度研究报告，而非简单的文章拼凑。
